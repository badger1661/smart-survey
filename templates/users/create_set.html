{% extends 'base.html' %}

{% block content %}
<div style="width: 50%; margin-left:auto; margin-right:auto;padding-bottom:15%">
        <div class="ui raised container segment">
        <div class="ui horizontal divider">Create New Class</div>
        <div class="ui form segment">
                <div class="field">
                    <label>Class Name</label>
                        <input id="set_name" type="text" placeholder="Class Name">
                    </div>
                    <div clas="field">
                    <label><b>Search for Students to add</b></label><br>
                    <div class="ui left icon input">
                            <input id="search_bar" type="text" placeholder="Search users...">
                            <i class="users icon"></i>
                        </div>
                        <div style="padding-top:1%">
                            <h4>Search Results:</h4>
                            <div>
                                <div class="ui relaxed divided list" id="suggested_students">
                                </div>
                            </div>
                            <h4>Students that will be added:</h4>
                            <div class="ui relaxed divided list" id="students_to_add">
    
                            </div>
                        </div>
                        </div>
                        <div class="ui divider"></div>
                    <button class="ui green button" id="create_class">Submit</button>
                        
                    </div>
            
</div>    
</div>

<script type="text/javascript">
var csrftoken = Cookies.get('csrftoken');

function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});

var suggested_students = $("#suggested_students");
var search_bar = $('#search_bar');

function clear(){
    suggested_students.empty(); 
    search_bar.val('');
}

    search_bar.keyup(function () {
        var keyword = search_bar.val();
        if (keyword.length > 2) {
            $.ajax({
                method: 'GET',
                url: '/class/create/',
                data: {
                    'keyword': keyword,
                },
                dataType: 'json',
                success: function (data) {
                    suggested_students.empty();
                    console.log(data)
                    var suggestions = data.students;
                    for (i = 0; i < suggestions.length; i++) {
                        var current_student = suggestions[i];
                        var div = $("<a href='#'><div/></a>");
                        div.data("name", current_student[0]);
                        div.data("id", current_student[2]);
                        div.html(current_student[0] + " (" + current_student[1]+ ")" + "<br>");
                        div.addClass('item');
                        div.on("click", moveProfile);
                        suggested_students.append(div);
                    }
                }


            })
        }
    })

var students_to_add = $("#students_to_add")
    var ids = []


    function moveProfile() {
        var $this = $(this);
        var studentID = $this.data("id");
        if (ids.indexOf(studentID) == -1) {
            ids.push(studentID);
            var studentName = $this.data("name");
            var studentEmail = $this.data("email")
            var div = $("<div/>");
            div.data('id', studentID);
            div.data('name', studentName);
            div.html("<div>" + studentName + "</div><div><button>Remove</button></div>");
            div.addClass("item");
            students_to_add.append(div);
            clear()
            //console.log(ids)}
        } else {
            clear()
        }
    }

        $('#students_to_add').on('click', 'button', function () {
        var $this = $(this).closest('.item');
        var studentID = $this.data("id");
        var pos = ids.indexOf(studentID);
        ids.splice(pos, 1);
        //console.log(ids);
        $this.remove();
    });

$("#create_class").on('click', function(){
    var error = false;
    var set_name = $("#set_name").val()
    var url = window.location.pathname;
    $.ajax({
        method: "POST",
        url: url,
        data: {
            'name': set_name,
            'student_ids': JSON.stringify(ids),
            },
        dataType: 'json',
        success: function (data) {
            location.href = data.url;//<--Redirect on success
        }
        });
})
    
</script>

{% endblock %}



<!--<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>
<script type="text/javascript">
var csrftoken = Cookies.get('csrftoken');

function csrfSafeMethod(method) {
    // these HTTP methods do not require CSRF protection
    return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
}
$.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
});




search_bar.keyup(function () {
    
    var keyword = search_bar.val();
    if(keyword.length > 2){
        //console.log('hey')
        var url = window.location.pathname;
        $.ajax({
            method: 'GET',
            url: url,
            data: {
            'keyword': keyword,
            },
            dataType: 'json',
            success: function (data) {
                suggested_students.empty(); 
                var suggestions = data.students;
                for(i = 0; i< suggestions.length; i++){
                    var current_student = suggestions[i];
                    var div = $("<a href='#'><div/></a>");
                    div.data("name", current_student[0]);
                    div.data("id", current_student[1]);
                    div.html(current_student[0] + "<br/>");
                    div.on("click", moveProfile);
                    div.css({"background-color": "light blue"});
                    suggested_students.append(div);
                }
            }
            })
        }else if(keyword.length == 0){
            clear()
            
        }
    })

var students_to_add = $("#students_to_add")
var ids = []
function moveProfile(){
    var $this = $(this);
    var studentID = $this.data("id");
    if (ids.indexOf(studentID) == -1){
    ids.push(studentID);
    var studentName = $this.data("name");
    var div = $("<div/>");
    div.data('id', studentID);
    div.data('name', studentName);
    div.html("<div>" + studentName +"</div><div><button>Remove</button></div>");
    div.css({"background-color": "light blue"});
    div.addClass("container");
    students_to_add.append(div);    
    clear()
    console.log(ids)}
    else{
        clear()
    }
}

$(function() {
    $('#students_to_add').on('click', 'button', function() {
    var $this = $(this).closest('.container');
    var studentID = $this.data("id");
    var pos = ids.indexOf(studentID);
    ids.splice(pos, 1);
    console.log(ids);
    $this.remove();
    });
  });

function send(){
    var set_name = $('#class_name').val();
    //console.log(ids)
    //console.log(set_name)
    var url = window.location.pathname;
    $.ajax({
        method: "POST",
        url: url,
        data: {
            'name': set_name,
            'student_ids': JSON.stringify(ids),
            },
        dataType: 'json',
        success: function (data) {
            //location.href = data.url;//<--Redirect on success
        }
        });
}
</script>
 -->

